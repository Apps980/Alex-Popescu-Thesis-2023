---
title: "R Script V5"
author: "Alex Popescu"
date: "2023-05-12"
output: github_document
editor_options: 
  chunk_output_type: console
---

V5 - Major overhaul and data/analysis improvement.

# MSC Thesis Script

> I used the advanced filter tool in BORIS to extract all instances where a behavior occurred in the presence and absence of a sentinel. This generated 6 tables.
> I then manually inputted the ID, generalized environment, number of **recorded** crows and whether or not the site was baited in the recording. I additionally removed observations in agricultural settings, and observations past September 29th.

### Reasoning

> The number of crows in the area is not a good estimate of group size. The number of foraging members during the foraging event should be better.
> Whether or not the site was baited will likely affect the duration of movement, since crows will need to look for food in non-baited recordings, while the crows have easy access to a large concentration of food in baited recordings. Therefore, the baited crows are expected to move less than non-baited crows.
> #KMG: I can imagine a reviewer would want to know hwo the baiting was standardized - something to keep in mind when you are writing. I removed the observations in agricultural settings because they had no sentinels present. This could be talked about in the discussion: agricultural fields may lack perches for individuals to act as sentinels. Vineyards may have some structures, but the visibility is limited when the vines are laden with fruit.\
> #KMG: This is something that can go in the methods. You had three sites, but one was removed due to lack of sentinals, and then you can have a bit in the discussion. I removed observations past Sept 29 because I was told behaviors can change wildly in the winter. The number of crows spotted decreased past that date, suggesting the migrants have left or were leaving. To not have to include time of year (I already have part of the breeding season), I decided to simplify.\

### Data Management

> After combining the 6 tables into a long one, labeling the behaviors and the presence of a sentinel on the way, I made sure that the headers were factors.\

```{r Packages, include=F}
library("tidyverse")
library("psych")
library("car")
library("ggplot2")
library("ggpattern")
library("lmerTest")
library("robustlmm")
library("sjPlot")
library("effects")
library("glmm")
library("doBy")
library("FactoMineR")
library("factoextra")
```

```{r Colorblind-friendly palette, include = F}
# The palette with black:
cbPalette <- c("#E69F00", "#56B4E9", "#CC79A7", "#009E73", "#F0E442", "#0072B2", "#D55E00")
```

```{r Open Crow and manage, include =F}
setwd(getwd())
Crow<-read.csv("Crow.csv", stringsAsFactors = T)
#Some management #
Crow$ID<-as.factor(Crow$ID)
Crow$Number.of.Crows<-as.numeric(Crow$Number.of.Crows)
Crow$CODED_BAIT<-as.numeric(Crow$CODED_BAIT)
Crow$CODED_G.ENV<-as.numeric(Crow$CODED_G.ENV)
Crow$CODED_NB_CROWS<-as.numeric(Crow$CODED_NB_CROWS)
Crow$CODED_SENTINEL<-as.numeric(Crow$CODED_SENTINEL)
Crow$CODED_BEHAVIOR<-as.numeric(Crow$CODED_BEHAVIOR)
Crow$LDur<-log(Crow$Duration+1)
```

```{r Crow Double checking, echo = F}
str(Crow)
```

> Good news! Observation ID, bait, presence of a sentinel and behavior are indeed recognized as factors! Number of crows and bout duration as a numeric variable.

# Bout Duration

## Figures

### Histogram

> I first decided to look at the distribution of my durations. I set up a histogram with the distibution of durations across all behaviors. I had to log-transform the duration to get a better distribution (log(Duration+1)).\

```{r Duration Histograms Individual, include = F}
Untransformed.Dur<-hist(Crow$Duration, breaks = 25)
Transformed.Dur<-hist(Crow$LDur, breaks = 25)
```

```{r Duration Histograms Combined, echo=F}
#KMG: good practice when changing par() things. I've added the code in. It will reset the parameters within the session
# par(mfrow = c(1,2))
op <- par(mfrow = c(1,2))
plot(Untransformed.Dur, main="Untransformed", ylab="Frequency", xlab="Duration (s)")
plot(Transformed.Dur, main="Transformed", ylab="", xlab="Log Duration (s)")
par(op)
```

```{r Crow Histogram, echo=F}
Hist<-ggplot(data = Crow) +
  geom_histogram(aes(fill = Behavior, x = LDur)
                 , alpha = 1
                 , bins = 50)+
  scale_fill_manual(values=cbPalette
                    , labels = c("Foraging", "Alert", "Moving"))+
  xlab("Log Duration (s)")+
  ylab("Count")
Hist
```

> I should use a robust linear mixed model. LMMs by themselves are robust against violations of their assumptions (I found an article about this), but I will nonetheless use 'robustlmm' to make my model, since their computations for weights are apparently better.

### Boxplot

```{r Crow boxplot, echo = F}
Box<-ggplot(data = Crow)+
  geom_boxplot_pattern(aes(x = G.Env, y = LDur, fill = Behavior, pattern = Sentinel)
                       , pattern_angle = 45
                       , pattern_size = 0.05
                       , pattern_spacing = 0.02
                       , color = "black")+
  theme(legend.position = "bottom")+
  scale_fill_manual(values = cbPalette
                    , labels = c("Foraging", "Alert", "Moving"))+
  scale_pattern_manual(values = c("crosshatch", "none")
                       , labels = c("Sentinel Absent", "Sentinel Present"))+
  guides(pattern = guide_legend(title = "Presence of a sentinel"
                                , override.aes = list(fill = c("white")))
         , fill = guide_legend(override.aes = list(pattern = "none")))+
  xlab("Generalized Environment")+
  ylab("Log Duration(s)") +
  theme(axis.title.x = element_blank()
        , legend.position = "bottom"
        , legend.box="vertical"
        , legend.margin=margin())
Box
```

### Violin plot

```{r Crow Violin plot, echo = F}
Violin<-ggplot(data = Crow
               , aes(x = Behavior, y = LDur, fill = Sentinel))+
  geom_violin()+
  theme_bw()+
  theme(legend.position = "bottom")+
  scale_fill_manual(values = cbPalette
                    , labels = c("Sentinel Absent", "Sentinel Present"))+
  scale_x_discrete(labels=c("Foraging", "Alert", "Moving"))+
  xlab("Generalized Environment")+
  ylab("Log Duration(s)")+
  facet_grid(~G.Env)+
  stat_summary(fun = "mean"
               , geom = "crossbar"
               , position = "dodge"
               , color = "red")
Violin
```

>These plots are nice, but it is hard to really see the underlying trends. To best visualise them, I'll next plot a dot plot.

### The Dot Plot

```{r Base R Plot, include = F}
source("./Calculate Summary Table with SE, SD, CI by grouping variables.R")
MeanDur <- summarySE(data = Crow, measurevar = "Duration"
                     , groupvars = c("G.Env", "Behavior", "Sentinel"))

plot(x = c(1:12)
     , y = MeanDur$Duration
     , xlim = c(0,12)
     , ylim = c(1,3)
     , type = "n"
     , ylab = "Duration (seconds)", xlab = "Generalized Environment")
arrows(c(1:12), MeanDur$Duration - MeanDur$se
       , c(1:12), MeanDur$Duration + MeanDur$se
       , length = 0.1, angle = 90, code = 3, lwd = 2)
points(x = c(1:12), y = MeanDur$Duration
       , pch = c(rep(c(16, 17), 3)), cex = 2
       , col = c("orange", "orange", "blue", "blue", "green", "green"))
legend(x = "bottomright", c("Sentinel Absent", "Sentinal Present", "Foraging", "Alert", "Moving")
       , bty = "o", cex = 1.05, bg = "white"
       , pch = c(16, 17, 15, 15, 15), col = c("black", "black", "orange", "blue", "green"))
#KMG: I'm not going to fix the X-axis labels and those kinds of things right now. I can do that if you like this plot or things it's informative. I think it's easier to see the differences. left side is commercial, right side is green. Legend should be correct.
```

```{r Dot Plot V2, echo = F}
source("./Calculate Summary Table with SE, SD, CI by grouping variables.R")
MeanDur <- summarySE(data = Crow, measurevar = "Duration"
                     , groupvars = c("G.Env", "Behavior", "Sentinel"))
DurDot<-ggplot(data = MeanDur
               , aes(x = G.Env
                     , y = Duration
                     , color = Behavior
                     , shape = Sentinel))+
  geom_point(position = position_dodge2(width = 0.9)
             , size = 3) +
  geom_errorbar(aes(ymin=(Duration-se)
                    , ymax=(Duration+se))
                , width = 0.2
                , position = position_dodge(width=0.9))+
  theme_bw() +
  ylab("Mean Bout Duration (s)") +
  scale_colour_manual(values = cbPalette
                      , labels = c("Foraging", "Alert", "Moving")) +
  scale_shape_manual(values = c(16,17)
                     , labels = c("Sentinel Absent"
                                  , "Sentinel Present")) +
  theme(axis.title.x = element_blank()
        , legend.position = "bottom"
        , legend.box="vertical"
        , legend.margin=margin())


DurDot
```

> Very cool! I think the last plot is the most informative. We can see that the presence of a sentinel increases the duration of bouts in commercial areas. In green areas, however, this effect is not observed. In fact, the bouts of Alert behavior seem significantly reduced in green areas and in the presence of a sentinel.

## The Tests

### PCAs
```{r Bout Duration PCA packages, include=F}
library("FactoMineR")
library("factoextra")
```
```{r Bout Duration PCA Book keeping, include=F}
PCA.Crow.Data<-Crow[,c(4,6,8,10,12:13)]
head(PCA.Crow.Data)
```
```{r Bout Duration PCA, echo=F}
PCA.Crow<-PCA(PCA.Crow.Data[,-5], ncp=5)
```

>I'm new to PCAs, so bear with me please. From what I see, presence of bait and sentinel, and the number of crows all contibute to PC1, while Generalized environment seems to be contributing to PC2. The behavior appears to contribute to PC2, but not a lot.

#### Eigenvalues

>Let's have a look at the eigenvalues.

``` {r Bout Duration PCA eigenvalues, echo = F}
Crow.eig.val<-get_eigenvalue(PCA.Crow)
Crow.eig.val
```

>Pretty small values. The second column shows how much contribution each dimension has to explain the total variance in the data. Let's quickly plot that.

#### Scree Plot

```{r Bout Duration PCA Scree Plot, echo = F}
fviz_eig(PCA.Crow, addlabels=T, ylim = c(0,40))
```

>Pretty cool. The first 3 PCs explain ~77% of the variance. Adding the 4th PC explains ~93% of the variation.

#### Contribution of variables to Principal Components

```{r Bout Duration PCA var results, include = F}
Crow.var<-get_pca_var(PCA.Crow)
```
```{r Bout Duration PCA Contribution Dim 1, echo=F}
fviz_contrib(PCA.Crow, choice="var", axes = 1, top = 20)
```

>The red dotted line represents the expected average contribution, assuming the contribution of the variables were uniform. In other words, the line is equal to 1/the number of variables; in this case 1/5 or 20%.

> From this plot, I can see that, as I saw previously in the correlation circle, the number of crows, the presence of a sentinel and the presence of bait contribute the most to PC1 (Dimension 1)

```{r Bout Duration PCA Contribution Dim 2, echo=F}
fviz_contrib(PCA.Crow, choice="var", axes = 2, top = 20)
```

> The generalized environment contributes the most to PC2.

```{r Bout Duration PCA Contribution Dim 3, echo=F}
fviz_contrib(PCA.Crow, choice="var", axes = 3, top = 20)
```

>The coded behavior contributes most to PC3.

```{r Bout Duration PCA Contribution Dim 4, echo=F}
fviz_contrib(PCA.Crow, choice="var", axes = 4, top = 20)
```

>OK! Now we're getting to the interesting bits. The presence of bait and the presence of a Sentinel contribute most to PC4. This makes me curious to see if there is an interaction between the two factors.

```{r Bout Duration PCA Contribution Dim 5, echo=F}
fviz_contrib(PCA.Crow, choice="var", axes = 5, top = 20)
```

>>The presence of a sentinel and the size of the group contribute most to PC 5. I believe this would imply that the interaction between the two could be interesting to look at. Considering these two variables are also major contributors to PC1, this makes the inclusion of the interaction in the model a must.

>From this, I believe I should look at the interaction between NB_Crows, Presence of a sentinel, and the presence of bait.

#### Plotting with Behaviors

>I'd like to plot the dimensions using the behaviors of the bouts.

```{r Bout Duration PCA Plot with Behavior PC1-2, echo=F}
fviz_pca_ind(PCA.Crow
             , geom.ind="point"
             , col.ind=PCA.Crow.Data$Behavior
             , palette = cbPalette
             , addEllipses = T
             , legend.title = "Behaviors"
             )
```

>Messy. The mean points of the behaviors are relatively centered.

```{r Bout Duration PCA Plot with Behavior PC2-3, echo=F}
fviz_pca_ind(PCA.Crow
             , axes = c(2,3)
             , geom.ind="point"
             , col.ind=PCA.Crow.Data$Behavior
             , palette = cbPalette
             , addEllipses = T
             , legend.title = "Behaviors"
             )
```

>Very clear separation by behavior type, with 'Head Up' shifted upward, 'Head Down' shifted downward, and 'Moving' in the middle.

```{r Bout Duration PCA Plot with Behavior PC1-3, echo=F}
fviz_pca_ind(PCA.Crow
             , axes = c(1,3)
             , geom.ind="point"
             , col.ind=PCA.Crow.Data$Behavior
             , palette = cbPalette
             , addEllipses = T
             , legend.title = "Behaviors"
             )
```

>Good separation, but the concentration ellipses have increased in size. Curious.

#### Biplot

>Finally, let's look at the biplot. From what I understand, it is essentially the correlation circle overlaid onto the data.

```{r Bout Duration PCA Biplot PC1-2, echo=F}
fviz_pca_biplot(PCA.Crow
                ,geom.ind = "point"
                , repel = T
                , col.ind=PCA.Crow.Data$Behavior
                , addEllipses = T
                , label = "var"
                , palette=cbPalette
                , col.var="black"
                , legend.title = "Behavior")
```
```{r Bout Duration PCA Biplot PC2-3, echo=F}
fviz_pca_biplot(PCA.Crow
                , axes = c(2,3)
                , geom.ind = "point"
                , repel = T
                , col.ind=PCA.Crow.Data$Behavior
                , addEllipses = T
                , label = "var"
                , palette=cbPalette
                , col.var="black"
                , legend.title = "Behavior")
```
```{r Bout Duration PCA Biplot PC1-3, echo=F}
fviz_pca_biplot(PCA.Crow
                , axes = c(1,3)
                , geom.ind = "point"
                , repel = T
                , col.ind=PCA.Crow.Data$Behavior
                , addEllipses = T
                , label = "var"
                , palette=cbPalette
                , col.var="black"
                , legend.title = "Behavior")
```

>Nice! I think I've done the PCA analysis to the best of my abilities, but I am very much open to comments and feedback!

>From what I can gather, I should model the data as follows:/
>LDur~Behavior+NB_Crows*Bait*Sentinel+G.Env+(1|ID)

### Assumption testing first

> I used robustlmm::rlmer to create the models. It takes longer to run than the regular lmer test because of the computations it makes to weigh the model. I then plotted the models to test the assumptions of the model.

> Behavior is expected to be affected by both the presence of a sentinel and the environment the crows are in. I am therefore curious to see the interactions between these factors. The presence of bait and number of crows are not linked with the presence of a sentinel or the environment. Arguably, larger groups are more likely to have sentinels than not, but I don't believe the interaction to be important here.

### RLMM

```{r Bout Duration Model Book keeping, include=F}
Crow$CODED_NB_CROWS<-as.factor(Crow$CODED_NB_CROWS)
```

```{r Duration RLMM, echo=F}
RLMM.Dur.I<-rlmer(LDur~Behavior+Sentinel*CODED_NB_CROWS*Baited+G.Env+ (1|ID), data = Crow)
plot(RLMM.Dur.I)
```

> That took pretty long to run. Let's next see the results of the model. I don't see huge deviations from the assumptions. According to the error message, my fixed-effect model matrix is rank deficient. I don't believe I need to worry too much about this warning.

```{r Duration RLMM Summary, echo = F}
summary(RLMM.Dur.I)
```

> A whole lot of numbers appear and no p-values. I want it to look better.

```{r Duration Better Summary, echo = F}
sjPlot::tab_model(RLMM.Dur.I
                  , show.re.var = T
                  , title = "Model Results with Interactions"
                  , dv.labels = " Effects of on duration of behaviors")

```

>Oh fun! Adding the three-way interaction caused all but the behavior to be non-significant. Let's try removing the interactions.

```{r Duration RLMM No Interactions, echo=F}
RLMM.Dur.NoI<-rlmer(LDur~Behavior+Sentinel+CODED_NB_CROWS+Baited+G.Env+ (1|ID), data = Crow)
sjPlot::tab_model(RLMM.Dur.NoI
                  , show.re.var = T
                  , title = "Model Results without Interactions"
                  , dv.labels = " Effects of on duration of behaviors")
```

>Same result!

>Let's try the good old regular lmer and see if that changes anything.

```{r Simpler output, echo = F}
Simple.Dur.I<-lmer(LDur~Behavior+Sentinel*CODED_NB_CROWS*Baited + G.Env + (1|ID), data = Crow)
Simple.Dur.NoI<-lmer(LDur~Behavior+Sentinel+CODED_NB_CROWS+Baited + G.Env + (1|ID), data = Crow)
anova(Simple.Dur.NoI, Simple.Dur.I)
```

>Using the simple model, I looked at the AIC values. The model without interactions had the lowest AIC value, therefore is preferred.Let's actually see what removing some factors in the model does to the AIC.

#### AIC Testing

```{r Bout Duration Drop1,echo=F}
drop1(Simple.Dur.NoI)
```

>Seems like dropping any of the variables will have no effect on the model's results. In other words, I can drop all factors except for 'behavior'.

```{r Bout Duration AIC testing}
Simplest.Dur<-lmer(LDur~Behavior+(1|ID), data=Crow)
anova(Simple.Dur.NoI, Simplest.Dur)
```

>Yep! The simplest model (LDur~Behavio+(1|ID)) is preferred. Let's try subsetting the data.

#### Subset Data
```{r Bout Duration Subset, include=F}
HU.Dur<-Crow[which(Crow$Behavior=="HU"),]
HD.Dur<-Crow[which(Crow$Behavior=="HD"),]
M.Dur<-Crow[which(Crow$Behavior=="M"),]
```
```{r Simple model on Subset HU data, echo=F}
Simple.HU.Dur<-lmer(LDur~Sentinel+CODED_NB_CROWS+Baited + G.Env + (1|ID), data =HU.Dur)
Anova(Simple.HU.Dur)
```

>Simple model on Head Up subset with no interactions shows no significance.

```{r Simple model on Subset HD data, echo=F}
Simple.HD.Dur<-lmer(LDur~Sentinel+CODED_NB_CROWS+Baited + G.Env + (1|ID), data =HD.Dur)
Anova(Simple.HD.Dur)
```

>Simple model on Head Down subset shows a significant effect of foraging group size, presence of bait and generalized environment.

```{r Simple model on Subset M data, echo=F}
Simple.M.Dur<-lmer(LDur~Sentinel+CODED_NB_CROWS+Baited + G.Env + (1|ID), data =M.Dur)
Anova(Simple.M.Dur)
```

> Simple model shows no significant effects.

### Bout Summary

>Ok! Considering only the 'Head Down' subset had significant effects, let's plot those results.

#### Bait

```{r Bait effect on HD bout, echo = F}
BaitPlot<- HD.Dur %>%
  summarySE(measurevar = "Duration"
            , groupvars = "Baited") %>%
  ggplot(aes(x = Baited, y = Duration))+
  geom_point(position = position_dodge(width = 0.9)
             , size = 3) +
  geom_text(aes(label = signif(Duration))
            , size = 3
            , position=position_dodge2(width=0.9, preserve='single')
            , hjust = -0.5
            , vjust = 0.1)+
  geom_errorbar(aes(ymin=(Duration-se), ymax=(Duration+se))
                , width = 0.2
                , position = position_dodge(width=.9))+
  theme_bw()+
  theme(text=element_text(size = 14))+
  xlab("Presence of Bait")+
  ylab("Mean Head Down Bout Duration (s)")+
  scale_x_discrete(labels=c("Not Baited", "Baited"))+
  theme(legend.position = 'bottom'
        )
BaitPlot
```

>Fun! The plot shows overlap between the standard error bars. In the presence of bait, crows will decrease the duration of their bouts of 'Head Down'.

#### G.Env

```{r G.Env effect on HD bout, echo = F}
EnvPlot<- HD.Dur %>%
  summarySE(measurevar = "Duration"
            , groupvars = "G.Env") %>%
  ggplot(aes(x = G.Env, y = Duration))+
  geom_point(position = position_dodge(width = 0.9)
             , size = 3) +
  geom_text(aes(label = signif(Duration))
            , size = 3
            , position=position_dodge2(width=0.9, preserve='single')
            , hjust = -0.5
            , vjust = 0.1)+
  geom_errorbar(aes(ymin=(Duration-se), ymax=(Duration+se))
                , width = 0.2
                , position = position_dodge(width=.9))+
  theme_bw()+
  theme(text=element_text(size = 14))+
  xlab("Generalized Environment")+
  ylab("Mean Head Down Bout Duration (s)")+
  theme(legend.position = 'bottom'
        )
EnvPlot
```

>Very nice! We can see that in Green Areas, the bout duration of head down behavior is increased. The error bars, as before, are standard error.

#### Foraging Group Size

```{r NB_Crows effect on HD bout, echo = F}
NBPlot<- HD.Dur %>%
  summarySE(measurevar = "Duration"
            , groupvars = "CODED_NB_CROWS") %>%
  ggplot(aes(x = CODED_NB_CROWS, y = Duration))+
  geom_point(position = position_dodge(width = 0.9)
             , size = 3) +
  geom_text(aes(label = signif(Duration))
            , size = 3
            , position=position_dodge2(width=0.9, preserve='single')
            , hjust = -0.5
            , vjust = 0.1)+
  geom_errorbar(aes(ymin=(Duration-se), ymax=(Duration+se))
                , width = 0.2
                , position = position_dodge(width=.9))+
  theme_bw()+
  theme(text=element_text(size = 14))+
  xlab("Group Size")+
  ylab("Mean Head Down Bout Duration (s)")+
  scale_x_discrete(labels=c("Small", "Large"))+
  theme(legend.position = 'bottom'
        )
NBPlot
```

>Very nice! In larger foraging groups, individuals increase their bouts of head down behavior.

>I can therefore make the following conclusions:
>-Crows do not modify the duration of bouts of head up or moving
>-Crows will modify the duration of bouts of head down behavior.
>-In larger groups, crows will increase the duration of bouts of 'Head Down", possibly due to the many eyes hypothesis.
>-In the presence of Bait, crows will decrease the duration of bouts of 'Head Down'. This could be due to the larger concentration of food in the patch, and therefore less time required to look for food. 
>-In Green Areas, crows will increase the duration of bouts of 'Head Down'. 

# Proportion Data

```{r Proportion setup, include = F}
DATA<-read.csv("DATA.csv", stringsAsFactors = T)
DATA$ID<-as.factor(DATA$ID)
DATA$ASIN_PROPORTION<-asin(sqrt(DATA$BEHAVIOR_PROPORTION))
```

```{r Proportion Double Check, echo = F}
str(DATA)
```

> All variables are correctly categorized

## Stacked barplot for proportion

> I also decided to make a stacked barplot to show the proportion of total time spent performing each behavior.

```{r Proportion Summary, echo = F}
MeanProp<-summarySE(DATA, "BEHAVIOR_PROPORTION", groupvars = c("GENERALIZED_ENVIRONMENT", "BEHAVIOR", "SENTINEL_PRESENCE"))
MeanProp
```

> Summary values are good, but graphs are better. Let's plot a stacked bar graph.

```{r Proportion Barplot, echo = F}
Prop<-ggplot(MeanProp, aes(x = SENTINEL_PRESENCE, y = BEHAVIOR_PROPORTION, fill = BEHAVIOR))+
  geom_bar(stat = 'identity', position = 'stack')+
  geom_text(aes(label = paste0(signif(BEHAVIOR_PROPORTION*100), "%")), position = position_stack(vjust = 0.5)
            , size = 3)+
  scale_y_continuous(labels = scales::percent) +
  theme_bw()+
  theme(text=element_text(size = 10)
        , axis.title.x = element_blank())+
  ylab("Proportion of time")+
  scale_x_discrete(labels=c("Sentinel Absent", "Sentinel Present"))+
  scale_fill_manual(values = cbPalette, labels = c("Foraging", "Alert", "Moving"), name="Behavior")+
  theme(legend.position = "bottom")+
  facet_grid(~GENERALIZED_ENVIRONMENT)
Prop
```

> The proportion figure shows something interesting: crows seem to spend longer times with their heads down in green areas than in commercial ones. Additionally, in the absence of a sentinel, individuals in green areas seemingly increased the proportion of time spent 'alert'.\
> \
> This could be caused by food being easier to find in commercial areas. Crows in green areas need to spend more time looking for food. This reinforces the need to include "Baited" in the model. In the absence of a sentinel, individuals are expected to rely more on individual vigilance, explaining the apparent increase in the proportion of time spent alert in green areas with no sentinels.

## To transform, or not to transform?

> In order to determine whether our fixed effects have significant effects on the allocation of time to each behavior, I decided to first arcsin square root transform the proportions.

```{r Proportion Histograms Individual, include = F}
Untransformed.Prop<-hist(DATA$BEHAVIOR_PROPORTION, breaks=25)
Transformed.Prop<-hist(DATA$ASIN_PROPORTION, breaks=25)
```

```{r Proportion Histograms Combined, echo=F}
op <- par(mfrow = c(1,2))
plot(Untransformed.Prop, main="Untransformed", ylab="Frequency", xlab="Proportion")
plot(Transformed.Prop, main="Transformed", ylab="", xlab="Asin(Sqrt(Proportion)")
par(op)
```

> Transformed data seems more normal than untransformed data. Will continue to use transformed data.

## PCAs

>Let's run another PCA

```{r DATA PCA SHEET, include=F}
PCA.DATA.SHEET<-DATA[,c(5,7,10,14,16,18,22,23,24,39)]
head(PCA.DATA.SHEET)
str(PCA.DATA.SHEET)
```
```{R DATA PCA, echo=F}
PCA.DATA<-PCA(PCA.DATA.SHEET[,c(-8,-9)])
```

>There are many variables here. I won't bother describing them here.

>Since the presence of a sentinel is not "God-Given", we'll run another PCA without that factor.

```{r DATA PCA NO SENTINEL, echo=F}
PCA.DATA.NOSENT<-PCA(PCA.DATA.SHEET[,c(-5,-8,-9)])
```

>Very similar to the one above.

### Scree Plot

```{r DATA PCA Scree Plot, echo = F}
get_eigenvalue(PCA.DATA)
fviz_eig(PCA.DATA, addlabels=T, ylim = c(0,40))
```

>The first PC covers ~40% of the variation. The first 4 PCs cover ~82% of the variation.

```{r DATA PCA Scree Plot NO SENTINEL, echo = F}
get_eigenvalue(PCA.DATA.NOSENT)
fviz_eig(PCA.DATA.NOSENT, addlabels=T, ylim = c(0,40))
```

>Excluding sentinel, the first PC covers ~43% of the variation, and the first 4 PCs cover ~86% of the total variation.

### Contribution of variables to Principal Components

```{r PCA DATA var results, include = F}
DATA.var<-get_pca_var(PCA.DATA)
DATA.NOSENT.var<-get_pca_var(PCA.DATA.NOSENT)
```
```{r PCA DATA Contribution Dim 1, echo=F}
fviz_contrib(PCA.DATA, choice="var", axes = 1, top = 12.5)
```

>Very weird, Julian Date, Decimal time, group size and generalized environment contribute greatly to PC1.

```{r PCA DATA Contribution Dim 2, echo=F}
fviz_contrib(PCA.DATA, choice="var", axes = 2, top = 12.5)
```

>Frequency of disturbances, group size (again), temperature and the presence of a sentinel contribute most to PC2.

```{r PCA DATA Contribution Dim 3, echo=F}
fviz_contrib(PCA.DATA, choice="var", axes = 3, top = 12.5)
```

>Temperature, Bait presence and decimal time contribute most to PC3.

```{r PCA DATA Contribution Dim 4, echo=F}
fviz_contrib(PCA.DATA, choice="var", axes = 4, top = 12.5)
```

>Sentinel presence, environment and frequency of disturbances contribute most to PC4.

>I'm still a little unclear as to how I should interpret these results.

#### No Sentinel

```{r PCA DATA.NOSENT Contribution Dim 1, echo=F}
fviz_contrib(PCA.DATA.NOSENT, choice="var", axes = 1, top = 14.29)
```

>Same 4 factors contribute the most to PC1 in the absence of the sentinel factor.

```{r PCA DATA.NOSENT Contribution Dim 2, echo=F}
fviz_contrib(PCA.DATA.NOSENT, choice="var", axes = 2, top = 14.29)
```

>Same as above, frequency of disturbances, temperature and group size contribute most to PC2 in the absence of the sentinel factor.

```{r PCA DATA.NOSENT Contribution Dim 3, echo=F}
fviz_contrib(PCA.DATA.NOSENT, choice="var", axes = 3, top = 14.29)
```

>Temperature, Bait presence and frequency of disturbances contribute the most to PC3 in the absence of a sentinel.

```{r PCA DATA.NOSENT Contribution Dim 4, echo=F}
fviz_contrib(PCA.DATA.NOSENT, choice="var", axes = 4, top = 14.29)
```

>Environment contributes most to PC4 in the absence of a sentinel.

### BiPlots
```{r DATA PCA Biplot PC1-2, echo=F}
fviz_pca_biplot(PCA.DATA
                ,geom.ind = "point"
                , repel = T
                , col.ind=PCA.DATA.SHEET$BEHAVIOR
                , addEllipses = T
                , label = "var"
                , palette=cbPalette
                , col.var="black"
                , legend.title = "Behavior")
```

>Messy, can't see where the behaviors lie.

```{r DATA PCA Biplot PC1-4, echo=F}
fviz_pca_biplot(PCA.DATA
                , axes = c(1,4)
                , geom.ind = "point"
                , repel = T
                , col.ind=PCA.DATA.SHEET$BEHAVIOR
                , addEllipses = T
                , label = "var"
                , palette=cbPalette
                , col.var="black"
                , legend.title = "Behavior")
```

>Still messy.

```{r DATA PCA Biplot PC2-3, echo=F}
fviz_pca_biplot(PCA.DATA
                , axes = c(2,3)
                , geom.ind = "point"
                , repel = T
                , col.ind=PCA.DATA.SHEET$BEHAVIOR
                , addEllipses = T
                , label = "var"
                , palette=cbPalette
                , col.var="black"
                , legend.title = "Behavior")
```

>Biplots are messy if we don't include behavior.

>Same is observed if we run the biplot in the absence of the sentinel factor.

>I'm not sure how to interpret these results.

## Simple Model

> Let's plot the simple model and test the assumptions. I'm using the same fixed effects as in the bout duration analyses. I am also adding some of the factors identified in the PCAs.

```{r Proportion Simple Assumptions, echo = F}
Simple.Prop <-lmer(ASIN_PROPORTION~BEHAVIOR+SENTINEL_PRESENCE+GENERALIZED_ENVIRONMENT+BAIT_PRESENCE+GROUP_SIZE+TOTAL_FREQUENCY_OF_DISTURBANCES+(1|ID)+(1|JULIAN_DATE)+(1|DECIMAL_TIME)+(1|TEMPERATURE), data = DATA)
plot(Simple.Prop)
```

> Not great. The warning I got means my model could have collinearity in its fixed effects (two variables explaining the same thing). Let's try dropping fixed effects one at a time.

>Let's see the results before we do anything.

```{r Proportion Model Results, echo = F}
Anova(Simple.Prop)
ranova(Simple.Prop)
```

>Interesting. For one, the results are insignificant. The other, the ranova results suggest that the model without random effects is preferred.

```{r Drop one}
drop1(Simple.Prop, test="Chisq")

```

>Removing factors has no significant effects on the model's output.

>Let's go to an even simpler model

### The even simpler models
```{r Proportion Simpler Models, echo = F}
Simpler.Prop1 <-lmer(ASIN_PROPORTION~BEHAVIOR+SENTINEL_PRESENCE+GENERALIZED_ENVIRONMENT+BAIT_PRESENCE+GROUP_SIZE+(1|ID), data = DATA)
Simpler.Prop2 <-lmer(ASIN_PROPORTION~BEHAVIOR+SENTINEL_PRESENCE+GENERALIZED_ENVIRONMENT+BAIT_PRESENCE+(1|ID), data = DATA)
Simpler.Prop3 <-lmer(ASIN_PROPORTION~BEHAVIOR+SENTINEL_PRESENCE+GENERALIZED_ENVIRONMENT+(1|ID), data = DATA)
Simpler.Prop4 <-lmer(ASIN_PROPORTION~BEHAVIOR+SENTINEL_PRESENCE+(1|ID), data = DATA)
Simpler.Prop5 <-lmer(ASIN_PROPORTION~BEHAVIOR+(1|ID), data = DATA)
anova(Simpler.Prop1,Simpler.Prop2,Simpler.Prop3,Simpler.Prop4,Simpler.Prop5)
```

>The simplest model, the one with only behavior as a FE and ID as a RE has the lowest AIC value. Weird...

```{r Proportion Simper Model 5 Results, echo = F}
Anova(Simpler.Prop5)
```

>Behavior is still insignificant. Could this be caused by the data transformation?

# Peck rate

> Using the peck data can allow us to infer if crows foraging effectiveness. More pecks per minute would imply that crows forage more actively. To analyse this, I used a linear mixed model with G.Env and presence of a sentinel and its interaction as fixed effects, and observation ID as the random effect.
>
> I calculated the pecks per minute of each individual recorded by dividing the number of pecks by the total head down duration (excluded time out of frame).

```{r Peck Setup, include=F}
DATA$LPek<-log(DATA$PECK_RATE)
```

## Histogram & Transformation

> First, I made a histogram and decided if transformation was appropriate.

```{r Peck Per Minute Histograms Individual, include = F}
Untransformed.PPM<-hist(DATA$PECK_RATE, na.rm=T, breaks = 12)
Transformed.PPM<-hist(DATA$LPek, breaks = 12)
```

```{r Peck Per Minute Histograms Combined, echo=F}
op <- par(mfrow = c(1,2))
plot(Untransformed.PPM, main="Untransformed", ylab="Frequency", xlab="Pecks per minute")
plot(Transformed.PPM, main="Transformed", ylab="", xlab="Log(Pecks per minute)")
par(op)
```

> Some gaps are present in the histogram. Log transformation made the distribution more normal.\
> Let's summarize the results:

## Peck Summary

```{r Peck Summary, echo = F}
### Summarize
MeanPeck<-summarySE(DATA, "PECK_RATE", c("GENERALIZED_ENVIRONMENT", "SENTINEL_PRESENCE"), na.rm=T)
MeanPeck
```

> Again, summary stats are good, but plots are better. Let's do that. Seems like peck rate is lower in the presence of a sentinel and in green areas. Standard error is relatively equal.

## Peck Plot

```{r Peck Plots, echo = F}
PeckPlot<-ggplot(MeanPeck, aes(x = GENERALIZED_ENVIRONMENT, y = PECK_RATE, colour = SENTINEL_PRESENCE))+
  geom_point(position = position_dodge(width = 0.9)
             , size = 3)+
  geom_text(aes(label = signif(PECK_RATE))
            , size = 3
            , position=position_dodge2(width=1, preserve='single')
            , hjust = -0.5
            , vjust = 0.1)+
  geom_errorbar(aes(ymin=(PECK_RATE-se), ymax=(PECK_RATE+se))
                , width = 0.2
                , position = position_dodge(.9))+
  theme_bw()+
  labs(colour = "Presence of a sentinel")+
  ylab("Mean pecks per minute")+
  scale_color_manual(values = cbPalette
                       , labels=c("Sentinel Absent", "Sentinel Present")) +
  scale_x_discrete(labels=c("Commercial", "Green Area"))+
  theme(legend.position = 'bottom'
        , legend.title = element_blank()
        , axis.title.x = element_blank()
        , text=element_text(size = 12))
PeckPlot
```

> It appears that there more pecks per minute in commercial areas in the presence of a sentinel.

## Simple Model

> At this point, let's use the model. As before, we are using the presence of a sentinel, the type of environment and their interaction as fixed effects, with the trial ID as a random effect.

```{r Simple peck, include= F}
DATA.PECK<-DATA[complete.cases(DATA),]
DATA.PECK<-DATA.PECK[DATA.PECK$BEHAVIOR_PROPORTION!=0,]
LMM.Peck<-lmer(LPek~SENTINEL_PRESENCE*GENERALIZED_ENVIRONMENT+BAIT_PRESENCE+(1|ID), data = DATA.PECK)
plot(LMM.Peck)
```

```{r Simple Peck Summary}
Anova(LMM.Peck)
ranova(LMM.Peck)
```

> Generalized environment and bait presence are significant. Weirdly, it seems to also prefer the model without the random effect.

## Plot time

### Generalized Environment

```{r G.Env effect on Peck Rate, echo = F}
EnvPlot.PECK<- DATA.PECK %>%
  summarySE(measurevar = "PECK_RATE"
            , groupvars = "GENERALIZED_ENVIRONMENT") %>%
  ggplot(aes(x = GENERALIZED_ENVIRONMENT, y = PECK_RATE))+
  geom_point(position = position_dodge(width = 0.9)
             , size = 3) +
  geom_text(aes(label = signif(PECK_RATE))
            , size = 3
            , position=position_dodge2(width=0.9, preserve='single')
            , hjust = -0.5
            , vjust = 0.1)+
  geom_errorbar(aes(ymin=(PECK_RATE-se), ymax=(PECK_RATE+se))
                , width = 0.2
                , position = position_dodge(width=.9))+
  theme_bw()+
  theme(text=element_text(size = 14))+
  xlab("Generalized Environment")+
  ylab("Peck Rate in Pecks per minute")+
  theme(legend.position = 'bottom'
        )
EnvPlot.PECK
```

>Very cool! Peck rate is increased in commercial areas.

### Bait

```{r Bait effect on Peck Rate, echo = F}
BAITPlot.PECK<- DATA.PECK %>%
  summarySE(measurevar = "PECK_RATE"
            , groupvars = "BAIT_PRESENCE") %>%
  ggplot(aes(x = BAIT_PRESENCE, y = PECK_RATE))+
  geom_point(position = position_dodge(width = 0.9)
             , size = 3) +
  geom_text(aes(label = signif(PECK_RATE))
            , size = 3
            , position=position_dodge2(width=0.9, preserve='single')
            , hjust = -0.5
            , vjust = 0.1)+
  geom_errorbar(aes(ymin=(PECK_RATE-se), ymax=(PECK_RATE+se))
                , width = 0.2
                , position = position_dodge(width=.9))+
  theme_bw()+
  theme(text=element_text(size = 14))+
  xlab("Bait Presence")+
  ylab("Peck Rate in Pecks per minute")+
  theme(legend.position = 'bottom'
        )
BAITPlot.PECK
```

>Seems like peck rate increases significantly in the presence of bait.