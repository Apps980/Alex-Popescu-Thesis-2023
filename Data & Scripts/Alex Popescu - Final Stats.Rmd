---
title: "Alex Popescu - Final Stats"
author: "Alex Popescu"
date: "`r Sys.Date()`"
output: 
  html_document: 
    keep_md: yes
editor_options: 
  markdown: 
    wrap: 72
---

# Bookkeeping

```{r Packages, include = F}
library("tidyverse")
library("psych")
library("car")
library("ggplot2")
library("lmerTest")
library("robustlmm")
library("sjPlot")
library("effects")
library("doBy")
library("emmeans")
library("formattable")
library("dplyr")
library("descr")
library("MASS")
library("jmv")
library("webshot")
library("kableExtra")
source("./Calculate Summary Table with SE, SD, CI by grouping variables.R")
```

```{r Colorblind-friendly palette, include = F}
# The palette with black:
cbPalette <- c("#E69F00", "#56B4E9", "#CC79A7", "#009E73", "#F0E442", "#0072B2", "#D55E00")
```

```{r Labels, include = F}
labs.prop<-c(
  '(Intercept)' = "Intercept"
  , SENTINEL_PRESENCEYES = "Sentinel Presence"
  , BEHAVIORHU = "Behavior"
  , 'GENERALIZED_ENVIRONMENTGreen Area' = "Generalized Environment"
  , GROUP_SIZESMALL = "Group Size"
  , BAIT_PRESENCEYES = "Bait Presence"
  , DISTURBANCE_FREQUENCY = "Disturbance Frequency"
  )

labs.bout.1<-c(
  '(Intercept)' = "Intercept"
  , 'SENTINEL_PRESENCESentinel Absent' = "Sentinel Presence"
  , BEHAVIORHU = "Behavior"
  , 'GENERALIZED_ENVIRONMENTGreen Area' = "Generalized Environment"
  , GROUP_SIZESMALL = "Group Size"
  , BAIT_PRESENCEYES = "Bait Presence"
  , DISTURBANCE_FREQUENCY = "Disturbance Frequency"
  , 'BEHAVIORHU:GENERALIZED_ENVIRONMENTGreen Area' = "Behavior: Generalized Environment"
  , 'BEHAVIORHU:SENTINEL_PRESENCESentinel Absent' = "Behavior: Sentinel Presence"
  , 'SENTINEL_PRESENCESentinel Absent:GENERALIZED_ENVIRONMENTGreen Area' = "Sentinel Presence: Generalized Environment"
)

labs.bout.2<-c(
  '(Intercept)' = "Intercept"
  , 'SENTINEL_PRESENCESentinel Absent' = "Sentinel Presence"
  , 'GENERALIZED_ENVIRONMENTGreen Area' = "Generalized Environment"
  , GROUP_SIZESMALL = "Group Size"
  , BAIT_PRESENCEYES = "Bait Presence"
  , DISTURBANCE_FREQUENCY = "Disturbance Frequency"
  ,'SENTINEL_PRESENCESentinel Absent:GENERALIZED_ENVIRONMENTGreen Area' = "Sentinel Presence: Generalized Environment"
  )

labs.peck<-c(
  '(Intercept)' = "Intercept"
  , SENTINEL_PRESENCEYES = "Sentinel Presence"
  , 'GENERALIZED_ENVIRONMENTGreen Area' = "Generalized Environment"
  , GROUP_SIZESMALL = "Group Size"
  , BAIT_PRESENCEYES = "Bait Presence"
  , DISTURBANCE_FREQUENCY = "Disturbance Frequency"
  , 'GENERALIZED_ENVIRONMENTGreen Area:DISTURBANCE_FREQUENCY' = "Generalized Environment: Disturbance Frequency"
  , 'SENTINEL_PRESENCEYES:GENERALIZED_ENVIRONMENTGreen Area' = "Sentinel Presence: Generalized Environment"
  )

labs.ptwy<-c('(Intercept)' = "Intercept"
  , 'SENTINEL_PRESENCESentinel Absent' = "Sentinel Presence"
  , 'GENERALIZED_ENVIRONMENTGreen Area' = "Generalized Environment"
  , BAIT_PRESENCEYES = "Bait Presence"
  , DISTURBANCE_FREQUENCY = "Disturbance Frequency"
  , 'SENTINEL_PRESENCESentinel Absent:GENERALIZED_ENVIRONMENTGreen Area' = "Sentinel Presence: Generalized Environment"
  )
```

```{r DATA.SR & BOUT}
DATA.SR<-read.csv("DATA.SR.csv", stringsAsFactors = T) %>%
  rename("VIDEO_ID" = "VIDEO_ID."
         , "ID" = "ID.")
BOUT.raw<-read.csv("BOUT.csv", stringsAsFactors = T)
```

# Proportion Data

```{r Open PROP}
PROP<-DATA.SR[,c(1,2,15,17,19,22,30,36,41,46)] %>% 
  subset(.
         , HU_BEHAVIOR_PROPORTION_... != 0 
         & HD_BEHAVIOR_PROPORTION_... != 0 
         ) %>% #Remove cases where proportion = 1 or 0
  rename("HU" = "HU_BEHAVIOR_PROPORTION_..."
         , "HD" = "HD_BEHAVIOR_PROPORTION_..."
         , "M" = "M_BEHAVIOR_PROPORTION_..."
         , "DISTURBANCE_FREQUENCY" = "TOTAL_FREQUENCY_OF_DISTURBANCES"
         ) %>%
  pivot_longer(., cols = c("HU"
                              , "HD"
                              , "M"
                           )
               , names_to = "BEHAVIOR"
               , values_to = "PROPORTION")

str(PROP)
```

For every individual, I divided the time spent performing each behavior
by the total time the individual was recorded. To remove outliers, I
removed all observations with no time spent performing one or more
behaviors (4 observations).

```{r PROP Summary}
PROP.SUMMARY <- summarySE(data = PROP
            , measurevar = "PROPORTION"
            , groupvars = c("GENERALIZED_ENVIRONMENT"
                            , "BEHAVIOR"
                            , "SENTINEL_PRESENCE"
                            )
            )
PROP.SUMMARY$SENTINEL_PRESENCE<-as.factor(replace(as.character(PROP.SUMMARY$SENTINEL_PRESENCE)
                                                  , PROP.SUMMARY$SENTINEL_PRESENCE=="NO"
                                                  , "Sentinel Absent"
                                                  )
                                          )

PROP.SUMMARY$SENTINEL_PRESENCE<-as.factor(replace(as.character(PROP.SUMMARY$SENTINEL_PRESENCE)
                                                  , PROP.SUMMARY$SENTINEL_PRESENCE=="YES"
                                                  , "Sentinel Present"
                                                  )
                                          )

PROP.SUMMARY
```

## PROP Stacked barplot

```{r PROP Barplot}
PROP.BARPLOT<-ggplot(PROP.SUMMARY
                 , aes(x = GENERALIZED_ENVIRONMENT
                       , y = PROPORTION
                       , fill = BEHAVIOR))+
  geom_bar(stat = 'identity'
           , position = 'stack')+
  geom_text(aes(label = paste0(formattable::digits(PROPORTION*100, dig=2)
                               , "%"))
            , position = position_stack(vjust = 0.5)
            , size = 4
            , family = "serif") +
  scale_y_continuous(labels = scales::percent) +
  theme_classic()+
  ylab("Proportion of time")+
  scale_x_discrete(labels=c("Commercial"
                            , "Green"))+
  scale_fill_manual(values = cbPalette, labels = c("Foraging"
                                                   , "Alert"
                                                   , "Moving")
                    , name="")+
  theme(legend.position = "bottom"
        , text = element_text(size = 18, family = "serif")
        , axis.title.x = element_blank()) +
  facet_grid(~SENTINEL_PRESENCE)
PROP.BARPLOT
```

To better visualize the effects of generalized environment and sentinel
presence, I calculated the mean proportion for each behavior and plotted
a stacked barplot for each combination of factors.

## PROP Model

```{r PROP Model}
PROP.MOD<-lm(PROPORTION~BEHAVIOR+SENTINEL_PRESENCE+GENERALIZED_ENVIRONMENT, data = subset(PROP, PROP$BEHAVIOR != "M"))

sjPlot::tab_model(PROP.MOD
                  , pred.labels = labs.prop
                  , show.stat = T
                  , show.se = T
                  , digits = 4
                  , show.re.var = T
                  , title = ""
                  , dv.labels = ""
                  , file = "Proportion_Table.html")
```
```{r Save PROP Table, include = F}
webshot("Proportion_Table.html", "Proportion_Table.png")
```

A linear model was performed. While all behaviors were included in the
model, "Moving" behavior was omitted from analysis, as not all bouts of
movement were recorded in their entirety.

Results: Crows allocate similar time to foraging and vigilance (Estimate
= 0.0263, SE = 0.0236, t-stat = 1.16, p = 0.248), and neither the
presence of a sentinel (Estimate = -0.0335, SE = 0.0234, t-stat =
-1.4314, p = 0.154) or the generalized environment (Estimate = 0.0336,
SE = 0.0230, t-stat = 1.4625, p = 0.146 have an effect on the
proportion of time allocated to either alert or foraging behavior.

# Bout Data

```{r Open BOUT}
BOUT<-BOUT.raw %>%
  filter(.
         , DURATION > 0.01) %>% #Remove impossibly small values
  filter(.
         , BEHAVIOR != "M") %>% #Remove "M"
  mutate(SENTINEL_PRESENCE = recode_factor(SENTINEL_PRESENCE
                         , 'YES' = "Sentinel Present"
                         , 'NO' = "Sentinel Absent"))
BOUT$LDURATION<-log(BOUT$DURATION) #Transform data for normality
str(BOUT)
```

In order to analyze the effects of generalized environment and the
presence of a sentinel on the duration of bouts, I first removed all
bouts of a duration shorter than 0.01s to remove impossibly small
outliers (likely artifacts from video coding in BORIS, 21 observations
removed), and removed all bouts where the individuals were moving as
they were not always recorded in their entirety (1173 observations
removed).

```{r BOUT Summary}
BOUT.SUMMARY <- summarySE(data = BOUT
                      , measurevar = "DURATION"
                      , groupvars = c("GENERALIZED_ENVIRONMENT"
                                      , "BEHAVIOR"
                                      , "SENTINEL_PRESENCE"
                                      )
                      ) %>%
  mutate(BEHAVIOR = recode_factor(BEHAVIOR
                                  ,'HD' = 'Foraging'#Rename HD as 'foraging'
                                  , 'HU' = 'Alert') #Rename HU as 'Alert'
                           )

BOUT.SUMMARY
```

## BOUT Dot Plot

```{r BOUT Dot Plot}
BOUT.DOTPLOT<-BOUT.SUMMARY %>%
           ggplot(.
               , aes(x = GENERALIZED_ENVIRONMENT
                     , y = DURATION
                     , colour = SENTINEL_PRESENCE))+
  geom_point(position = position_dodge(width = 0.1)
             , size = 3
             ) +
  geom_errorbar(aes(ymin=(DURATION-se)
                    , ymax=(DURATION+se))
                , width = 0.1
                , position = position_dodge(width=0.1))+
  geom_text(aes(label = round(DURATION, 2))
            , hjust = -0.2
            , size = 6
            , show.legend = F
            , family = "serif") +
  theme_classic() +
  ylab("Mean Bout Duration (s)") +
  scale_colour_manual(values = cbPalette
                      , labels = c("Sentinel Absent", "Sentinel Present")
                      , name = "") +
  scale_x_discrete(labels = c("Commercial", "Green"))+
  theme(axis.title.x = element_blank()
        , legend.position = "bottom"
        , legend.box="vertical"
        , legend.margin=margin()
        , text = element_text(size = 18, family = "serif")
        ) +
  facet_grid(~BEHAVIOR)

BOUT.DOTPLOT
```

> The error bars represent the standard error, while the symbols are the
> mean duration of bouts.

## BOUT Model - All behaviors

```{r BOUT Model - All behaviors}
BOUT.MOD<-rlmer(LDURATION~BEHAVIOR*SENTINEL_PRESENCE+BEHAVIOR*GENERALIZED_ENVIRONMENT+SENTINEL_PRESENCE*GENERALIZED_ENVIRONMENT+GROUP_SIZE+BAIT_PRESENCE+DISTURBANCE_FREQUENCY+(1|ID), data = BOUT)

sjPlot::tab_model(BOUT.MOD
                  , pred.labels = labs.bout.1
                  , show.re.var = T
                  , show.se = T
                  , show.stat = T
                  , digits = 4
                  , title = ""
                  , dv.labels = "")

sjPlot::plot_model(BOUT.MOD
                  , axis.labels = labs.bout.1
                  , show.values=T
                  , show.p=T
                  , value.offset = 0.4
                  , value.size = 3.5
                  , wrap.title = 48
                  , show.re.var = T
                  , title = ""
                  ) +
  theme_sjplot(base_family = "serif" )
```

I then visualized the data and ran a robust linear mixed model on the
bouts of all behaviors using the following structure:

\$Log(Bout Duration) \~ Behavior X Sentinel Presence + Behavior X
Generalized Environment + Sentinel Presence X Generalized Environment +
Group Size + Bait Presence + Disturbance Frequency + ( 1 \| Individual
ID ) \$

Where the behavior, presence of a sentinel, generalized environment,
group size, bait presence, and disturbance frequency are fixed effects,
while the individual ID is the random effect.

I subsequently ran robust linear mixed models on each behavior
separately, using a similar formula as described above.

RESULTS: Bouts of alertness and foraging were significantly different
(Estimate = -0.2557, SE = 0.0511, t-stat = -5.002, p = \<0.001), with
bouts of alertness being significantly shorter than bouts of vigilance.

Sentinel presence increased the duration of all bouts significantly
(Estimate = 0.1974, SE = 0.0720, t-stat = 2.7406, p = 0.006). All bouts
in green areas were significantly longer than those in commercial areas
(Estimate = 0.3534, SE = 0.0873, t-stat = 4.0482, p = \<0.001). The
interaction between generalized environment and sentinel presence had a
significant effect (Estimate = -0.2524, SE = 0.0882, t-stat = -2.8630, p
= 0.004).

The interaction between behavior type and generalized environment was
also significant (Estimate = -0.2023, SE = 0.0537, t-stat = -3.7690, p =
\<0.001).

Lastly, disturbance frequency had a significant effect on the duration
of all bouts (Estimate = -0.0878, SE = 0.0295, t-stat = -2.9748, p =
0.003), with bout duration decreasing as disturbance frequency
increased.

```{r BOUT Post Hoc - All Behaviors}
BOUT.DIFF.ALL_BEHAVIORS<-emmeans(BOUT.MOD, ~SENTINEL_PRESENCE*GENERALIZED_ENVIRONMENT, pbkrtest.limit = 5070)
kbl(test(pairs(BOUT.DIFF.ALL_BEHAVIORS), by = NULL, adjust="fdr"), format = "html", digits = 4, caption = "Bout post hoc - All behaviors", col.names = c("Contrast", "Estimate", "SE", "df", "z-ratio", "p"), align = "lccccc" )%>%
  kable_classic(html_font = "Times New Roman") %>%
  save_kable(file = "Bout_PH_All Behaviors.html", self_contained = T)
```
```{r Save Bout Post Hoc - All Behaviors, include = F}
webshot("Bout_PH_All Behaviors.html", "Bout_PH_All Behaviors.png")
```

RESULTS Post-hoc pairwise testing revealed significant differences in
the duration of all bouts. The following results are averaged over the
levels of bait, group size and bait presence, and the p-values are
adjusted using the 'FDR' method for 6 tests. In commercial areas, the
presence of a sentinel increased the duration of foraging bouts
(Estimate = -0.157, SE = 0.0653, z-ratio = -2.402, p = 0.0489). In the
absence of a sentinel, foragers in green areas had longer foraging bouts
(Estimate = -0.252, SE = 0.0821, z-ratio = -3.074, p = 0.0127). Foragers
in commercial areas and in the absence of a sentinel had a marginally
significant effect, shortening foraging bouts in green areas and in the
presence of a sentinel (Estimate = -0.157, SE = 0.0720, z-ratio =
-2.117, p = 0.0589). All other comparisons were not significant (p \<
0.3430)

```{r BOUT - DISTURBANCES Figure}
BOUT.DOTPLOT.DISTURBANCES<-BOUT %>%
           ggplot(.
               , aes(x = DISTURBANCE_FREQUENCY
                     , y = DURATION
                     ))+
  geom_point(size = 2
             , colour = cbPalette[1]
             , alpha = 0.5
             )+
  geom_smooth(method = "lm"
              , se = F
              , colour = cbPalette [2]) +
  theme_classic() +
  xlab("Disturbance Frequency (per minute)") +
  ylab("Bout Duration (s)") +
  theme(legend.position = "none"
        , text = element_text(size = 18, family = "serif")
        )

BOUT.DOTPLOT.DISTURBANCES
```

##BOUT Model - Head Down

```{r BOUT Model - Head Down}
BOUT.MOD.HD<-rlmer(LDURATION~SENTINEL_PRESENCE*GENERALIZED_ENVIRONMENT+GROUP_SIZE+BAIT_PRESENCE+DISTURBANCE_FREQUENCY+(1|ID), data = subset(BOUT, BEHAVIOR == "HD"))

sjPlot::tab_model(BOUT.MOD.HD
                  , pred.labels = labs.bout.2
                  , show.re.var = T
                  , show.se = T
                  , show.stat = T
                  , digits = 4
                  , title = ""
                  , dv.labels = "")

sjPlot::plot_model(BOUT.MOD.HD
                  , axis.labels = labs.bout.2
                  , show.values=T
                  , show.p=T
                  , value.offset = 0.4
                  , value.size = 3.5
                  , wrap.title = 48
                  , show.re.var = T
                  , title = "") +
  theme_sjplot(base_family = "serif")

```

RESULTS: Sentinel presence had no significant effect on the duration of
bouts of foraging (Estimate = 0.0919, SE = 0.0718, t-stat = 1.2799, p =
0.201).

Generalized environment had a significant effect on the duration of
bouts of foraging, with bouts being longer in green areas (Estimate =
0.3826, SE = 0.0778, t-stat = 4.9194, p = \<0.001). The interaction
between generalized environment and sentinel presence was also
significant (Estimate = -0.2272, SE = 0.0914, t-stat = -2.4849, p =
0.013).

Increasing group size significantly increased the duration of bouts of
foraging behavior (Estimate = -0.1519, SE = 0.0684, t-stat = -2.2205, p
= 0.026).

The presence of bait decreased the duration of foraging bouts (Estimate
= -0.1385, SE = 0.0697, t-stat = -1.9885, p = 0.047).

Increasing disturbance frequency significantly decreased the duration of
foraging bouts (Estimate = -0.1075, SE = 0.0301, t-stat = -3.5664, p =
\<0.001).

```{r BOUT Post Hoc - Foraging}
BOUT.DIFF.HD<-emmeans(BOUT.MOD.HD, ~SENTINEL_PRESENCE*GENERALIZED_ENVIRONMENT, pbkrtest.limit = 5070)
kbl(test(pairs(BOUT.DIFF.HD), by = NULL, adjust="fdr"), format = "html", digits = 4, caption = "Bout post hoc - Foraging", col.names = c("Contrast", "Estimate", "SE", "df", "z-ratio", "p"), align = "lccccc" )%>%
  kable_classic(html_font = "Times New Roman") %>%
  save_kable(file = "Bout_PH_HD.html", self_contained = T)
```
```{r Save Bout Post Hoc - Foraging, include = F}
webshot("Bout_PH_HD.html", "Bout_PH_HD.png")
```

```{r BOUT HD - Group Size Figure}
BOUT.DOTPLOT.GROUP_SIZE<-BOUT %>%
  filter(., BEHAVIOR == "HD") %>%
  summarySE(., measurevar = "DURATION", groupvar = "GROUP_SIZE") %>%
           ggplot(.
               , aes(x = GROUP_SIZE
                     , y = DURATION
                     , colour = GROUP_SIZE
                     ))+
  geom_point(position = position_dodge(width = 0.1)
             , size = 3
             ) +
  geom_errorbar(aes(ymin=(DURATION-se)
                    , ymax=(DURATION+se))
                , width = 0.1
                , position = position_dodge(width=0.1))+
  geom_text(aes(label = round(DURATION, 2))
            , hjust = -0.2
            , size = 6
            , show.legend = F
            , family = "serif"
            ) +
  theme_classic() +
  xlab("Group Size") +
  ylab("Mean Foraging Bout Duration (s)") +
  scale_color_manual(values = cbPalette) +
  scale_x_discrete(labels = c("Small Group"
                                  , "Large Group")
                   , limits = c("SMALL", "LARGE")) +
  theme(axis.title.x = element_blank()
        , legend.position = "none"
        , legend.box="vertical"
        , legend.margin=margin()
        , text = element_text(size = 18, family = "serif")
        )

BOUT.DOTPLOT.GROUP_SIZE
```

```{r BOUT HD - BAIT_PRESENCE Figure}
BOUT.DOTPLOT.BAIT<-BOUT %>%
  filter(., BEHAVIOR == "HD") %>%
  summarySE(., measurevar = "DURATION", groupvar = "BAIT_PRESENCE") %>%
           ggplot(.
               , aes(x = BAIT_PRESENCE
                     , y = DURATION
                     , colour = BAIT_PRESENCE
                     ))+
  geom_point(position = position_dodge(width = 0.1)
             , size = 3
             ) +
  geom_errorbar(aes(ymin=(DURATION-se)
                    , ymax=(DURATION+se))
                , width = 0.1
                , position = position_dodge(width=0.1))+
  geom_text(aes(label = round(DURATION, 2))
            , hjust = -0.2
            , size = 6
            , show.legend = F
            , family = "serif") +
  theme_classic() +
  ylab("Mean Foraging Bout Duration (s)") +
  scale_color_manual(values = cbPalette) +
  scale_x_discrete(labels = c("Bait Absent"
                                  , "Bait Present")) +
  theme(axis.title.x = element_blank()
        , legend.position = "none"
        , legend.box="vertical"
        , legend.margin=margin()
        , text = element_text(size = 18, family = "serif")
        )

BOUT.DOTPLOT.BAIT
```

```{r BOUT HD - DISTURBANCES Figure}
BOUT.DOTPLOT.DISTURBANCES.HD<-BOUT %>%
  filter(., BEHAVIOR == "HD") %>%
           ggplot(.
               , aes(x = DISTURBANCE_FREQUENCY
                     , y = DURATION
                     ))+
  geom_point(size = 2
             , colour = cbPalette[1]
             , alpha = 0.5
             )+
  geom_smooth(method = "lm"
              , se = F
              , colour = cbPalette [2]) +
  theme_classic() +
  xlab("Disturbance Frequency (per minute)") +
  ylab("Foraging Bout Duration (s)") +
  theme(legend.position = "none"
        , text = element_text(size = 18, family = "serif")
        )

BOUT.DOTPLOT.DISTURBANCES.HD
```

## BOUT Model - Head Up

```{r BOUT Model - Head Up}
BOUT.MOD.HU<-rlmer(LDURATION~SENTINEL_PRESENCE*GENERALIZED_ENVIRONMENT+GROUP_SIZE+BAIT_PRESENCE+DISTURBANCE_FREQUENCY+(1|ID), data = subset(BOUT, BEHAVIOR == "HU"))

sjPlot::tab_model(BOUT.MOD.HU
                  , pred.labels = labs.bout.2
                  , show.re.var = T
                  , show.se = T
                  , show.stat = T
                  , digits = 4
                  , title = "Head Up"
                  , dv.labels = " Effects on alert bout duration")+
  theme_sjplot(base_family = "serif")

sjPlot::plot_model(BOUT.MOD.HU
                  , axis.labels = labs.bout.2
                  , show.values=T
                  , show.p=T
                  , value.offset = 0.4
                  , value.size = 3.5
                  , wrap.title = 48
                  , show.re.var = T
                  , title = "Effects on alert bout duration") +
  theme_sjplot(base_family = "serif")

```

RESULTS: In contrast to foraging behavior, generalized environment,
group size, bait presence and disturbance frequency had no significant
effect on the duration of bouts of alert behavior (p \< 0.141).

Sentinel behavior did not have an effect on the duration of alert
behavior.

However, the interaction between sentinel behavior and generalized
environment was significant (Estimate = -0.2736, SE = 0.1352, t-stat =
-2.0243, p = 0.043).

```{r Save BOUT Tables, include = F}
sjPlot::tab_model(c(BOUT.MOD, BOUT.MOD.HD, BOUT.MOD.HU)
                  , pred.labels = labs.bout.1
                  , show.re.var = T
                  , show.se = T
                  , show.stat = T
                  , digits = 4
                  , order.terms = c(1,3,4,5,6,7,10,2,8,9)
                  , title = ""
                  , dv.labels = c("Bouts of all behaviors"
                                  , "Bouts of foraging behavior"
                                  , "Bouts of alert behavior")
                  , file = "Bout_Table.html"
                  )
webshot("Bout_Table.html", "Bout_Table.png")



```

#Peck Rate

```{r Open PECK}
PECK<-DATA.SR[,c(1,2,15,17,19,22,30,38,48)] %>%
  subset(., HD_BEHAVIOR_DURATION > 0) %>%
  rename("DISTURBANCE_FREQUENCY" = "TOTAL_FREQUENCY_OF_DISTURBANCES")
  
str(PECK)
```

The peck rate was calculated for every individual by dividing the total
number of pecks at food performed by the total duration of foraging (or
'Head Down') behavior. Individuals that did not forage were excluded.

```{r PECK Summary, echo = F}
PECK.SUMMARY<-summarySE(PECK, "PECK_RATE"
                     , c("GENERALIZED_ENVIRONMENT"
                         , "SENTINEL_PRESENCE")
                     , na.rm=T)
PECK.SUMMARY
```

## PECK Dot Plot

```{r PECK Dot Plot}
PECK.DOTPLOT<-ggplot(data = PECK.SUMMARY
               , aes(x = GENERALIZED_ENVIRONMENT
                     , y = PECK_RATE
                     , color = SENTINEL_PRESENCE))+
  geom_point(position = position_dodge(width = 0.9)
             , size = 3
             ) +
  geom_errorbar(aes(ymin=(PECK_RATE-se)
                    , ymax=(PECK_RATE+se))
                , width = 0.1
                , position = position_dodge(width=0.9))+
  geom_text(aes(label = scales::label_number(accuracy=0.01)(PECK_RATE))
            , position = position_dodge(width = 0.4)
            , size = 6
            , show.legend = F
            , family = "serif"
            ) +
  theme_classic() +
  ylab("Mean Peck Rate (per min)") +
  scale_colour_manual(values = cbPalette
                      , labels = c("Sentinel Absent", "Sentinel Present")
                      , name = "")+
  scale_x_discrete(labels = c("Commercial"
                                  , "Green")) +
  theme(axis.title.x = element_blank()
        , legend.position = "bottom"
        , legend.box="vertical"
        , legend.margin=margin()
        , text = element_text(size = 18, family = "serif"))

PECK.DOTPLOT
```

## PECK Model

I then ran another robust linear mixed model using a similar formula as
for the bout duration. Sentinel presence, generalized environment, group
size, bait presence and the total frequency of disturbances per minute
were used as fixed effects, with the individual ID used as a random
factor.

```{r PECK Model}
PECK.MOD<-rlmer(PECK_RATE~SENTINEL_PRESENCE*GENERALIZED_ENVIRONMENT+GENERALIZED_ENVIRONMENT*DISTURBANCE_FREQUENCY+GROUP_SIZE+BAIT_PRESENCE+(1|ID), data = PECK)

sjPlot::tab_model(PECK.MOD
                  , pred.labels = labs.peck
                  , show.re.var = T
                  , show.se = T
                  , show.stat = T
                  , digits = 4
                  , title = ""
                  , dv.labels = ""
                  , file = "Peck_Table.html")

sjPlot::plot_model(PECK.MOD
                  , axis.labels = labs.peck
                  , show.values=T
                  , show.p=T
                  , value.offset = 0.4
                  , value.size = 3.5
                  , wrap.title = 48
                  , show.re.var = T
                  , title = "" ) +
  theme_sjplot(base_family = "serif")
```
```{r Save Peck Table, include = F}
webshot("Peck_Table.html", "Peck_Table.png")
```

RESULTS Neither the presence of a sentinel nor the generalized
environment alone had a significant effect on the peck rate of foragers
(p \> 0.702).

Peck rate increases significantly as disturbance frequency increases
(Estimate = 5.29, t = 2.312, p = 0.021), with the interaction between
generalized environment and disturbance frequency also significantly
affecting peck rate (Estimate = 16.15, t = 3.046, p = 0.002).

Lastly, the presence of bait significantly increased the peck rate of
foragers (Estimate = 13.99, t = 2.231, p = 0.020).

## Disturbance Frequency x Generalized Environment

```{r PECK Disturbance plot}
PECK.DOTPLOT.DISTURBANCE<-PECK %>%
    ggplot(aes(x = DISTURBANCE_FREQUENCY
               , y = PECK_RATE
               , color = GENERALIZED_ENVIRONMENT))+
  geom_point(size = 3) +
  geom_smooth(method = "lm", se = F) +
  theme_classic() +
  labs(y="Peck Rate (per min)", x="Disturbance Frequency (per min)")+
  scale_x_continuous(n.breaks=14)+
  theme(legend.position = "bottom"
        , text = element_text(size = 18, family = "serif"))+
  scale_color_manual(values = cbPalette
                    , labels = c("Commercial Area"
                                 , "Green Area")
                    , name="")
  

PECK.DOTPLOT.DISTURBANCE
```

RESULTS Green areas appear to have much fewer disturbances than
commercial areas.

```{r PECK Dot Plot - Bait Presence}
PECK.DOTPLOT.BAIT<-PECK %>%
  summarySE(.
            , measurevar = "PECK_RATE"
            , groupvars = "BAIT_PRESENCE") %>%
  ggplot(.
         , aes(x = BAIT_PRESENCE
                     , y = PECK_RATE
                     , colour = BAIT_PRESENCE
               ))+
  geom_point(position = position_dodge(width = 0.1)
             , size = 3
             ) +
  geom_errorbar(aes(ymin=(PECK_RATE-se)
                    , ymax=(PECK_RATE+se))
                , width = 0.1
                , position = position_dodge(width=0.1))+
  geom_text(aes(label = round(PECK_RATE, 2))
            , hjust = -0.2
            , size = 6
            , show.legend = F
            , family = "serif") +
  theme_classic() +
  ylab("Mean Peck Rate (per min)") +
  scale_x_discrete(labels = c("Baited Absent"
                                  , "Bait Present")) +
  scale_color_manual(values = cbPalette) +
  theme(axis.title.x = element_blank()
        , legend.position = "none"
        , legend.box="vertical"
        , legend.margin=margin()
        , text = element_text(size = 18, family = "serif"))

PECK.DOTPLOT.BAIT
```

# Sentinel Likelihood

```{r open SENT}
SENT<-DATA.SR[1:81,c(1,7,10,15,17,19,20,22,30,31)] %>%
  distinct()
str(SENT)
```

A chi-squared test was performed to determine if there were
environmental or social factors that affected the likelihood of a
sentinel being present in our videos.

```{r SENT Summary}
SENT.SUMMARY <- summarySE(data = SENT
                      , measurevar = "GROUP_SIZE" #Random
                      , groupvars = c("GENERALIZED_ENVIRONMENT"
                                      , "SENTINEL_PRESENCE"
                                      )
                      )

SENT.SUMMARY
```

## SENT Barplot

```{r SENT Barplot}
SENT.BARPLOT <- ggplot(SENT.SUMMARY, aes(x=GENERALIZED_ENVIRONMENT
                 , fill = SENTINEL_PRESENCE
                 , y = N
                 , group = SENTINEL_PRESENCE)) + 
  geom_bar(stat='identity', width=.5, position = "dodge") +
  geom_text(aes(label = N, group = SENTINEL_PRESENCE)
            , position = position_dodge(width = 0.5)
            , vjust = 1.5
            , size = 8
            , family = "serif") +
  ylab("Number of observations") +
  theme_classic() +
  scale_fill_manual(""
                    , values = cbPalette
                    , labels = c("Sentinel Absent", "Sentinel Present")
                      ) +
  scale_x_discrete(labels = c("Commercial"
                              , "Green")) +
  theme(axis.title.x = element_blank()
        , text = element_text(size = 18, family = "serif")
        , legend.position = "bottom"
        , legend.box="vertical"
        , legend.margin=margin())
  
SENT.BARPLOT
```

## SENT Chi-Squared

```{r SENT Chi-Squared}
SENT.CHISQ<-lapply(SENT[,c("GENERALIZED_ENVIRONMENT"
                      , "GROUP_SIZE"
                      , "DISTURBANCE_FREQUENCY"
                      )
                              ]
                         , function(x) CrossTable(x,SENT$SENTINEL_PRESENCE
                                                  , fisher = T
                                                  , chisq = T
                                                  , expected = T
                                                  , prop.c = F
                                                  , prop.t = F
                                                  , prop.chisq = F
                                                  , sresid = T
                                                  , format = 'SPSS'
                                                  )
                         )

SENT.CHISQ
```

RESULTS Neither the generalized environment (Chi\^2 = 0.1221515, df = 1,
p = 0.727), group size (Chi\^2 = 0.2481203, df = 1, p = 0.618 ), or the
disturbance frequency (Chi\^2 = 2.032678, df = 2, p = 0.362)
significantly affected the likelihood of a sentinel being present.

##SENT Plots - Continuous Variables

```{r SENT Frequency plots}
SENT.FREQ <- SENT %>% 
  rename("Temperature (deg. C)" = "TEMPERATURE"
         , "Decimal Time" = "DECIMAL_TIME"
         , "Disturbance Frequency (per min)" = "TOTAL_FREQUENCY_OF_DISTURBANCES"
         , "Number of Crows" = "NUMBER_OF_CROWS_RECORDED") %>%
  pivot_longer(., cols = c(#"Temperature (deg. C)"
                           # , "Decimal Time"
                           "Number of Crows"
                           , "Disturbance Frequency (per min)")
               , names_to = "Var"
               , values_to = "Val") %>%
  ggplot(aes(
    x = Val
    , colour = SENTINEL_PRESENCE))+
  geom_freqpoly(linewidth = 1
                , alpha=I(.6)) +
  scale_colour_manual(values = cbPalette
                      , name = ""
                      , labels = c("Sentinel Absent"
                                   , "Sentinel Present")) +
  facet_wrap(~Var, scale = "free_x") +
  theme_classic() +
  theme(legend.position = "bottom"
        , axis.title.x = element_blank()
        , text = element_text(size = 18, family = "serif"))

SENT.FREQ
```

# Pathway Analysis

I calculated the likelihood of one behavior following another by
dividing the number of transitions from one behavior to another by the
total number of transitions from that behavior.

```{r Subsetting PTWY}
PTWY<- DATA.SR %>%
  dplyr::select(VIDEO_ID,ID, DECIMAL_TIME, GENERALIZED_ENVIRONMENT, SENTINEL_PRESENCE, BAIT_PRESENCE, NUMBER_OF_CROWS_RECORDED, GROUP_SIZE, TOTAL_NB_TRANSITIONS, TOTAL_FREQUENCY_OF_DISTURBANCES | starts_with("NB_")) %>%
  rename("DISTURBANCE_FREQUENCY" = "TOTAL_FREQUENCY_OF_DISTURBANCES"
         , "Transitions" = "TOTAL_NB_TRANSITIONS") %>%
  mutate(SENTINEL_PRESENCE = recode_factor(SENTINEL_PRESENCE
                         , 'YES' = "Sentinel Present"
                         , 'NO' = "Sentinel Absent"))

```

### PTWY Plots

```{r PTWY Plots}
PTWY.SUMMARY<-PTWY %>%
  rename("Foraging to Peck" = "NB_HD.HDP"
         , "Alert to Foraging" = "NB_HU.HD"
         , "Foraging to Alert" = "NB_HD.HU"
         , "Peck to Alert" = "NB_HDP.HU"
         ) %>%
  pivot_longer(., cols = c("Foraging to Peck"
                           , "Alert to Foraging"
                           , "Foraging to Alert"
                           , "Peck to Alert"
                           )
               , names_to = "TRANSITION"
               , values_to = "PTWY") %>%
  summarySE(.
            , measurevar = "PTWY"
            , groupvars = c("TRANSITION"
                            , "SENTINEL_PRESENCE"
                            , "GENERALIZED_ENVIRONMENT"))

PTWY.BOXPLOT<-PTWY %>%
  rename("Foraging to Peck" = "NB_HD.HDP"
         , "Alert to Foraging" = "NB_HU.HD"
         , "Foraging to Alert" = "NB_HD.HU"
         , "Peck to Alert" = "NB_HDP.HU"
         ) %>%
  pivot_longer(., cols = c("Foraging to Peck"
                           , "Alert to Foraging"
                           , "Foraging to Alert"
                           , "Peck to Alert"
                           )
               , names_to = "TRANSITION"
               , values_to = "PTWY") %>%
    ggplot(.
           , aes(x = GENERALIZED_ENVIRONMENT
                 , y = PTWY
                 , colour = SENTINEL_PRESENCE)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(aes(x = GENERALIZED_ENVIRONMENT
                  , group = SENTINEL_PRESENCE)
              , position = position_jitterdodge(jitter.width = 0.5)
              , alpha = 0.25
              ) +
  geom_point(data = PTWY.SUMMARY
             , aes( x = GENERALIZED_ENVIRONMENT
                    , y = PTWY
                    , group = SENTINEL_PRESENCE)
             , size = 2
             , colour = "black"
             , position = position_dodge(width = 0.75)) +
  geom_errorbar(data = PTWY.SUMMARY
                , aes(ymin=(PTWY-se)
                    , ymax=(PTWY+se)
                    , group = SENTINEL_PRESENCE
                    , x = GENERALIZED_ENVIRONMENT)
                , width = 0.2
                , colour = "black"
                , position = position_dodge(width=0.75
                                            )) +
  theme_classic() +
  ylab("Number of Transitions") +
  scale_colour_manual(values = cbPalette
                      , labels = c("Sentinel Absent"
                                   , "Sentinel Present")
                      , name = "") +
  scale_x_discrete(labels = c("Commercial", "Green")
                   )+
  theme(axis.title.x = element_blank()
        , legend.position = "bottom"
        , legend.box="vertical"
        , legend.margin=margin()
        , text = element_text(size = 14, family = "serif")
        ) +
  facet_grid(~TRANSITION)

PTWY.BOXPLOT
```

### GLMM

A generalized linear mixed model with a poisson distribution was
performed to assess changes in the frequency of transitions to each
behavior. Sentinel presence, generalized environment, disturbance
frequency and bait presence were used as fixed effects, with the total
number of transitions as a random effect.

```{r PTWY GLMM}
PTWY.MODELS<-list()
DV<-list("NB_HD.HU"
         , "NB_HD.HDP"
         , "NB_HU.HD"
         , "NB_HDP.HU"
         )


for (y in DV){
  formula<-formula(paste(y,"~SENTINEL_PRESENCE*GENERALIZED_ENVIRONMENT+DISTURBANCE_FREQUENCY+BAIT_PRESENCE+(1|Transitions)"))
  PTWY.MODELS[[y]]<-glmer(formula, data = PTWY, family = "poisson", control=glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=100000)))
}

tab_model(PTWY.MODELS
          , pred.labels = labs.ptwy
                  , show.re.var = T
                  , show.se = T
                  , show.stat = T
                  , digits = 4
                  , title = ""
                  , dv.labels = c("Foraging to Alert"
                                  , "Foraging to Peck"
                                  , "Alert to Foraging"
                                  , "Peck to Alert")
          )+
  theme_sjplot(base_family = "serif")
```
```{r Save PTWY Table, include = F}
webshot("PTWY_Table.html", "PTWY_Table.png")
```

```{r PTWY Post Hoc}
PTWY.DIFF<-emmeans(PTWY.MODELS$NB_HD.HU, ~SENTINEL_PRESENCE*GENERALIZED_ENVIRONMENT)
kbl(test(pairs(PTWY.DIFF), by = NULL, adjust="fdr"), format = "html", digits = 4, caption = "Pathway analysis post hoc", col.names = c("Contrast", "Estimate", "SE", "df", "z-ratio", "p"), align = "lccccc" )%>%
  kable_classic(html_font = "Times New Roman") %>%
  save_kable(file = "PTWY_PH.html", self_contained = T)
```
```{r Save PTWY} Post Hoc - Foraging, include = F}
webshot("PTWY_PH.html", "PTWY_PH.png")
```


RESULTS Transitions from head down to pecking were significantly
affected by the presence of bait, with more transitions occuring in the
presence of bait (IRR = 1.7096, SE = 0.3842, z-stat = 2.3858, p =
0.017). All other factors did not affect this transition.

Transitions from pecking to head up were similarly affected by the
presence of bait, significantly increasing when bait was present (IRR =
2.2037, SE = 0.5378, z-stat = 3.2378, p = 0.001).

Transitions from head up to head down were not affected by any factors,
but bait presence had a marginally significant effect (IRR = 1.5134, SE
= 0.3506, z-stat - 1.7888, p = 0.074). In the presence of bait, the
number of transitions from head up to head down appears to increase.

Transitions from head down to head up, from vulnerability to vigilance,
were significantly affected by generalized environment, disturbance
frequency, and the interaction between generalized environment and
sentinel presence.

In the absence of a sentinel, individuals exhibited marginally more
transitions from foraging to alert behavior in commercial areas
(Estimate = 0.864, SE = 0.372, z-ratio = 2.321, p = 0.0608). However, in
the presence of a sentinel, individuals exhibited marginally more of the
same transitions in green areas (Estimate = -0.749, SE = 0.363, z-ratio
= -2.062, p = 0.0785).

In green areas, individuals performed more transitions from foraging to
alert behavior when in the presence of a sentinel (Estimate = -1.124, SE
= 0.346, z-ratio = -3.250, p = 0.0069).

```{r PTWY Figures - Bait Presence}
PTWY.DOTPLOT.BAIT<-PTWY %>%
  rename("Foraging to Peck" = "NB_HD.HDP"
         , "Alert to Foraging" = "NB_HU.HD"
         , "Foraging to Alert" = "NB_HD.HU"
         , "Peck to Alert" = "NB_HDP.HU"
         ) %>%
  pivot_longer(., cols = c("Foraging to Peck"
                           , "Alert to Foraging"
                           , "Foraging to Alert"
                           , "Peck to Alert"
                           )
               , names_to = "TRANSITION"
               , values_to = "PTWY"
               ) %>%
  summarySE(.
            , measurevar = "PTWY"
            , groupvars = c("BAIT_PRESENCE"
                            , "TRANSITION" 
                            )
            ) %>%
  ggplot(.
           , aes(x = BAIT_PRESENCE
                 , y = PTWY
                 , colour = BAIT_PRESENCE)
         ) +
  geom_point(position = position_dodge(width = 0.9)
             ) +
  geom_errorbar(aes(ymin=(PTWY-se)
                    , ymax=(PTWY+se)
                    )
                , width = 0.2
                ) +
    geom_text(aes(label = scales::label_number(accuracy = 0.01)(PTWY)
                  , x = BAIT_PRESENCE
                  , colour = BAIT_PRESENCE)
            , hjust = -0.1
            , show.legend = F
            , family = "serif") +
  theme_classic() +
  ylab("Number of Transitions") +
  xlab("Bait Presence") +
  scale_color_manual(values = cbPalette) +
  scale_x_discrete(labels = c("Absent"
                              , "Present")) +
  theme(legend.position = "none"
        , legend.box="vertical"
        , legend.margin=margin()
        , text = element_text(size = 18, family = "serif")
        ) +
  facet_grid(~TRANSITION)

PTWY.DOTPLOT.BAIT
```

```{r PTWY Figures - Disturbance Frequency}
PTWY.DOTPLOT.DISTURBANCE<- PTWY %>%
  ggplot(.
         , aes(x = DISTURBANCE_FREQUENCY
               , y = NB_HD.HU
               )
         ) +
  geom_point(colour = cbPalette[1]
             ) +
  geom_smooth(method = "glm"
              , method.args = list(family = poisson)
              , colour = cbPalette[2]
              ) +
  theme_classic() +
  xlab("Disturbance Frequency (per min)") +
  ylab("Transitions from Foraging to Alert")+
  theme(text = element_text(size = 18, family = "serif"))

PTWY.DOTPLOT.DISTURBANCE
```